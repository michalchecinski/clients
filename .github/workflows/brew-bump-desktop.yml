---
name: Bump Desktop Cask

on:
  push:
    tags:
      - desktop-v**
  workflow_dispatch:

defaults:
  run:
    shell: bash

jobs:
  update-desktop-cask:
    name: Update Bitwarden Desktop Cask
    runs-on: macos-11
    steps:
      - name: Login to Azure
        uses: Azure/login@6453efca84e884a7848c9681f6515bf7732bd20b
        with:
          creds: ${{ secrets.AZURE_PROD_KV_CREDENTIALS }}

      - name: Retrieve secrets
        id: retrieve-secrets
        uses: Azure/get-keyvault-secrets@c2b531e47fab4ca7cd8df09d44a65256651bf46e
        with:
          keyvault: "bitwarden-prod-kv"
          secrets: "brew-bump-workflow-pat"

      - name: Update Homebrew cask
        uses: macauley/action-homebrew-bump-cask@a2196a934c01ed13c1fd823ad980672d4c6e8f47
        with:
          # Required, custom GitHub access token with the 'public_repo' and 'workflow' scopes
          token: ${{ steps.retrieve-secrets.outputs.brew-bump-workflow-pat }}
          org: bitwarden
          tap: Homebrew/homebrew-cask
          cask: bitwarden
          tag: ${{ github.ref }}
          revision: ${{ github.sha }}
          force: false
          dryrun: true
